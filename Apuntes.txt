Apuntes ML
-------------------------------

Predecir la probabilidad de que ocurra una r√©plica importante, y un rango de tiempo, usando 
modelo de √°rbol de decisi√≥n y KNN para las 2 etapas de predicci√≥n complementandose mutuamente
https://www.kaggle.com/datasets/nicolasgonzalezmunoz/earthquakes-on-chile

8.4, Coquimbo 2015
8,2, Noroeste Iquique, Pisagua 2014



Fecha m√°s antigua: 2012-03-03 11:01:47
Fecha m√°s reciente: 2025-05-26 03:50:27

Date Latitud Longitud Profundidad Magnitud
---------------------------------------------------------------------------------------------

VARIABLES PRINCIPALES
Columna: id_sismo_principal

Tipo: Texto

Descripci√≥n: Identificador √∫nico de cada sismo

C√≥mo se genera: Combinando fecha + latitud + longitud del sismo principal
----------------------------
Columna: celda_geografica

Tipo: Texto

Descripci√≥n: Zona de agrupaci√≥n de 1¬∞x1¬∞ (approx. 111km)

C√≥mo se genera: Redondeando latitud y longitud a grados enteros
----------------------------
Columna: magnitud_umbral

Tipo: Num√©rico

Descripci√≥n: Magnitud m√≠nima para considerar una r√©plica como "fuerte"

C√≥mo se genera: Magnitud del sismo principal menos 1.0
------------------------------------------------------------------
--------------------------------------------------------
VARIABLES OBJETIVO (TARGET)
Columna: existe_replica_fuerte

Tipo: Binario (1/0)

Descripci√≥n: Indica si hubo al menos una r√©plica fuerte (ETAPA 1)

C√≥mo se genera: 1 si se encontr√≥ r√©plica ‚â• magnitud_umbral en 3 d√≠as
-----------------------
Columna: ventana_temporal_replica

Tipo: Categ√≥rica (1,2,3,4)

Descripci√≥n: Indica cu√°ndo ocurrir√° la r√©plica fuerte (ETAPA 2)

C√≥mo se genera:

1: R√©plica en 0-24 horas

2: R√©plica en 24-48 horas

3: R√©plica en 48-72 horas

4: R√©plica despu√©s de 72 horas
---------------------------------------------------------------
--------------------------------------------------------------
VARIABLES GEOGR√ÅFICAS
Columna: zona_sismica

Tipo: Categ√≥rica

Descripci√≥n: Regi√≥n de Chile donde ocurri√≥ el sismo

C√≥mo se genera: Norte (lat < -30¬∞), Centro (lat -30¬∞ a -40¬∞), Sur (lat > -40¬∞)
--------------------------
Columna: distancia_a_costa

Tipo: Num√©rico

Descripci√≥n: Distancia aproximada del epicentro a la costa

C√≥mo se genera: C√°lculo de distancia a l√≠nea costera de Chile
--------------------------------------------------------------
-----------------------------------------------------
VARIABLES TEMPORALES
Columna: estacion_a√±o

Tipo: Categ√≥rica

Descripci√≥n: Estaci√≥n del a√±o del sismo principal

C√≥mo se genera: Verano/Oto√±o/Invierno/Primavera seg√∫n fecha

-----------------------------------------------------------------------
-----------------------------------------------------------
VARIABLES T√âCNICAS
Columna: es_sismo_somero

Tipo: Binario (1/0)

Descripci√≥n: Indica si el sismo es superficial

C√≥mo se genera: 1 si profundidad < 70km, 0 si ‚â• 70km
---------------------------------------

Columna: intensidad_categoria

Tipo: Categ√≥rica

Descripci√≥n: Categor√≠a de intensidad del sismo principal

C√≥mo se genera:

Suave: M < 6.0

Moderado: M 6.0-7.0

Fuerte: M 7.0-8.0

Extremo: M > 8.0
-------------------------------------------------------------------------
-----------------------------------------------------------------
VARIABLES HIST√ìRICAS
Columna: actividad_reciente_zona

Tipo: Num√©rico

Descripci√≥n: Actividad s√≠smica previa en la zona

C√≥mo se genera: Cantidad de sismos > M5 en la misma celda en los √∫ltimos 30 d√≠as
-----
 actividad_reciente_zona ‚Üí AMPLIAR
Problema: Solo considera sismos > M5
Mejora:

python
# Nueva columna: actividad_reciente_completa
- Sismos > M5 en √∫ltimos 15 d√≠as
- Sismos > M6 en √∫ltimos 30 d√≠as  
- Sismos > M7 en √∫ltimos 90 d√≠as
----------------------------------------------------------------------
Columna: brecha_magnitud_zona

Tipo: Num√©rico

Descripci√≥n: Diferencia con magnitud m√°xima hist√≥rica de la zona

C√≥mo se genera: magnitud_principal - m√°xima_magnitud_registrada_en_la_zona
-----------------------------------------------------------------------
Columna: ratio_replicas_historico

Tipo: Num√©rico

Descripci√≥n: Promedio hist√≥rico de r√©plicas por sismo en la zona

C√≥mo se genera: Total r√©plicas hist√≥ricas / Total sismos principales en la celda
ratio_replicas_historico ‚Üí DESGLOSAR
Problema: Demasiado general
Mejora:

python
# Tres columnas espec√≠ficas:
ratio_replicas_24h: % de sismos con r√©plica en 0-24h
ratio_replicas_48h: % de sismos con r√©plica en 0-48h  
ratio_replicas_72h: % de sismos con r√©plica en 0-72h
--------------------------------------
Para la COLABORACI√ìN √Årbol + KNN:
1. densidad_sismica_zona
Tipo: Num√©rico

Descripci√≥n: Cantidad total de sismos hist√≥ricos en la celda

C√≥mo se genera: count(sismos_totales_en_celda) / √°rea_celda

Raz√≥n: KNN necesita saber si la zona tiene suficiente data hist√≥rica para confiar en los vecinos
-------------------------------

2. similitud_promedio_vecinos
Tipo: Num√©rico (0-1)

Descripci√≥n: Qu√© tan similares son los vecinos m√°s cercanos

C√≥mo se genera: Promedio de similitud de los 5 vecinos m√°s cercanos

Raz√≥n: Indicador de confianza para KNN - si los vecinos son muy distintos, menor confianza
------------------------
3. conflicto_modelos
Tipo: Binario (1/0)

Descripci√≥n: Indica si √Årbol y KNN dan predicciones diferentes

C√≥mo se genera: 1 si (√°rbol_predice_S√ç y KNN_confianza < 0.3) o viceversa

Raz√≥n: Para detectar casos donde los algoritmos no coinciden
----------------------------
4. energia_liberada_estimada
Tipo: Num√©rico

Descripci√≥n: Energ√≠a s√≠smica aproximada en joules

C√≥mo se genera: 10^(1.5*magnitud + 4.8)

Raz√≥n: Feature importante para ambos algoritmos
-------------------------------------------------
Variables para el √ÅRBOL (Reglas):
# Features de estructura clara:
['zona_sismica', 'intensidad_categoria', 'es_sismo_somero', 
 'distancia_a_costa', 'estacion_a√±o', 'actividad_reciente_completa']

Variables para el KNN (Similitud):
# Features de distancia significativas:
['magnitud', 'profundidad', 'latitud', 'longitud', 'energia_liberada_estimada',
 'densidad_sismica_zona', 'ratio_replicas_24h', 'ratio_replicas_48h']
Variables de CONTROL:

# Para monitorear la colaboraci√≥n:
['similitud_promedio_vecinos', 'conflicto_modelos', 'celda_geografica']



---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

PASO 1: Evaluaci√≥n de Riesgo (AMBOS)
   ‚Üì
√Årbol: Calcula probabilidad basada en reglas
KNN: Busca vecinos similares y su historial
   ‚Üì
COMBINACI√ìN: Decisi√≥n consensuada con nivel de confianza

PASO 2: Estimaci√≥n Temporal (AMBOS)  
   ‚Üì
KNN: Distribuci√≥n temporal basada en vecinos
√Årbol: Reglas generales de timing
   ‚Üì
COMBINACI√ìN: Timing probabil√≠stico con explicaciones






-----------------------------------------------------------------------

M√°s ejemplos (‚â•5.5) reducen varianza de tus estimadores; el modelo aprende mejor patrones generales.
Menos ejemplos (‚â•6.0) aumentan riesgo de sobreajuste y de que alguna ventana (ej. 48‚Äì72h) quede con muy pocos ejemplos.

üîç Recomendaci√≥n: USAR ‚â• 6.0 como "Sismo Importante"
¬øPor Qu√© ‚â• 6.0?
1. Calidad sobre Cantidad:
python
# Con ‚â• 6.0:
- 121 sismos ‚Üí Suficiente para entrenar modelos
- Mejor se√±al/ruido ‚Üí Sismos realmente significativos
- Menos falsos positivos en an√°lisis

# Con ‚â• 5.5:
- 285 sismos ‚Üí M√°s datos pero m√°s ruido
- Incluye sismos que quiz√°s no generan r√©plicas importantes
- Mayor desbalance (4018 total vs 285)

-----------------------------------------------------------------------
Var obj 1
0: no en < 72 H
1: si en < 72 H

Var obj 2
1: 0 24hrs
2:24 48hrs
3:48 72hrs
4: > 72 h
5: no hubo r√©plicas

------------------------------------------------------------------------

Para entrenar modelos:

Etapa 1 (clasificar existe_replica_fuerte):

Dataset: seismic_features_fusion_final.csv filtrando es_mainshock==1.
Target: existe_replica_fuerte (0/1).
Balance: usar class_weight (no oversampling).
Etapa 2 (clasificar ventana 0‚Äì24h vs 24‚Äì72h):

Dataset base: etapa2_train_filtrado.csv 
(mainshocks con existe_replica_fuerte==1 y ventana_temporal_replica ‚àà {1,2}).

Dataset alternativo: etapa2_train_balanced.csv 
(solo para comparar si mejora Recall; no para an√°lisis estad√≠stico).
Target: ventana_temporal_replica (1 vs 2).
Balance: probar primero filtrado + class_weight; 
luego comparar con balanceado sin class_weight.

---------------------------
### ‚ö†Ô∏è CUIDADO: La Accuracy puede Enga√±ar con Datos Desbalanceados

**Pregunta importante:** ¬øPor qu√© kNN tiene mayor Accuracy que Decision Tree si no detecta ninguna r√©plica?

**Respuesta:** Con datos desbalanceados (92 sin r√©plica vs 3 con r√©plica),
 un modelo puede tener **alta Accuracy simplemente prediciendo siempre 
 "No habr√° r√©plica"**.

**Ejemplo real con nuestros resultados:**
- **kNN:** Accuracy=94.7% pero Recall=0% (no detecta NINGUNA r√©plica)
- **Decision Tree:** Accuracy=57.9% pero Recall=33.3% 
(detecta 1 de 3 r√©plicas)

**¬øC√≥mo es posible?**

kNN predice "No" casi siempre ‚Üí acierta en 90 de 92 casos 
negativos = 94.7% accuracy
Pero falla en los 3 casos positivos ‚Üí 0% recall (lo que realmente importa)

Decision Tree predice "S√≠" m√°s veces ‚Üí hace 38 falsas alarmas
Pero detecta 1 de 3 r√©plicas ‚Üí 33.3% recall (mejor para seguridad)

**Lecci√≥n:** En problemas desbalanceados de seguridad, 
**NO uses Accuracy como m√©trica principal**. Usa **Recall** 
(detectar casos peligrosos) y **F1-Score** (balance).


-------------------------------------------------
Promedios (excluyendo folds con 0 positivos):
Accuracy:  0.724 ¬± 0.126
Precision: 0.222 ¬± 0.098
Recall:    0.875 ¬± 0.250
F1-Score:  0.347 ¬± 0.137

-----------------------------------------------


üìä Resultados Etapa 2 - Clasificaci√≥n Multiclase
‚ö†Ô∏è Hallazgo Importante
El dataset tiene solo 2 clases temporales (no 4):

Clase 1: 24-72h (19 eventos, 76%)
Clase 2: >72h (6 eventos, 24%)
Sin clase 0 (0-24h) ni clase 3 en los 25 mainshocks con r√©plica
üéØ Rendimiento de Modelos
Decision Tree (mejor):

Accuracy: 60%
F1-Macro: 0.524
Acierta 5/7 r√©plicas clase 1 (24-72h)
Acierta 1/3 r√©plicas clase 2 (>72h)
kNN (bajo rendimiento):

Accuracy: 10%
F1-Macro: 0.091
Solo acierta 1/10 predicciones total
‚úÖ Modelos Guardados
decision_tree_etapa2_FINAL.pkl (max_depth=3, entrenado con 25 eventos)
scaler_etapa2_FINAL.pkl
imputer_etapa2_FINAL.pkl
columnas_features_etapa2.txt
üí° Interpretaci√≥n Realista
Para proyecto acad√©mico:

‚úÖ Demuestra clasificaci√≥n multiclase correctamente
‚úÖ Aplica class_weight='balanced'
‚úÖ Validaci√≥n temporal apropiada
‚ö†Ô∏è Dataset extremadamente peque√±o (25 eventos, solo 10 en test)
El Decision Tree logra 60% accuracy, lo cual es razonable dado 
el dataset tan peque√±o. El sistema est√° listo para integrarse 
en la cascada.